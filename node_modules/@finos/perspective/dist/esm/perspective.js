var M=Object.defineProperty;var z=(r,e)=>{for(var t in e)M(r,t,{get:e[t],enumerable:!0})};var v={};z(v,{COLUMN_SEPARATOR_STRING:()=>H,CONFIG_ALIASES:()=>B,CONFIG_VALID_KEYS:()=>U,DATA_TYPES:()=>D,FILTER_OPERATORS:()=>n,SORT_ORDERS:()=>V,SORT_ORDER_IDS:()=>J,TYPE_AGGREGATES:()=>K,TYPE_FILTERS:()=>X});var D={integer:"integer",float:"float",string:"string",boolean:"boolean",date:"date",datetime:"datetime",object:"object"},B={row_pivot:"group_by","row-pivot":"group_by","row-pivots":"group_by",col_pivot:"split_by",col_pivots:"split_by",column_pivot:"split_by","column-pivot":"split_by","column-pivots":"split_by",filters:"filter",sorts:"sort"},U=["viewport","group_by","split_by","aggregates","columns","filter","sort","computed_columns","expressions","group_by_depth","split_by_depth","filter_op"],L=["any","avg","abs sum","count","distinct count","dominant","first by index","last by index","last minus first","last","high","join","low","high minus low","max","mean","median","min","pct sum parent","pct sum grand total","stddev","sum","sum abs","sum not null","unique","var"],x=["any","count","distinct count","distinct leaf","dominant","first by index","join","last by index","last","unique"],W=["any","count","distinct count","distinct leaf","dominant","first by index","last by index","last","unique"],V=["none","asc","desc","col asc","col desc","asc abs","desc abs","col asc abs","col desc abs"],J=[2,0,1,0,1,3,4,3,4],K={string:x,float:L,integer:L,boolean:W,datetime:x,date:x},n={lessThan:"<",greaterThan:">",equals:"==",lessThanOrEquals:"<=",greaterThanOrEquals:">=",doesNotEqual:"!=",isNull:"is null",isNotNull:"is not null",isIn:"in",isNotIn:"not in",contains:"contains",bitwiseAnd:"&",bitwiseOr:"|",and:"and",or:"or",beginsWith:"begins with",endsWith:"ends with"},Y=[n.bitwiseAnd,n.bitwiseOr,n.equals,n.doesNotEqual,n.or,n.and,n.isNull,n.isNotNull],C=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull],$=[n.equals,n.contains,n.doesNotEqual,n.isIn,n.isNotIn,n.beginsWith,n.endsWith,n.isNull,n.isNotNull],G=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull],H="|",X={string:$,float:C,integer:C,boolean:Y,datetime:G,date:G};var O={types:{float:{filter_operator:"==",aggregate:"sum",format:{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}},string:{filter_operator:"==",aggregate:"count"},integer:{filter_operator:"==",aggregate:"sum",format:{}},boolean:{filter_operator:"==",aggregate:"count"},datetime:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short",timeStyle:"medium"},null_value:-1},date:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short"},null_value:-1}}};function T(r){let e={};if(b().types[r]&&Object.assign(e,b().types[r]),e.type){let t=T(e.type);return Object.assign(t,e),t}else return e}function N(r){return r&&typeof r=="object"&&!Array.isArray(r)}function y(r,...e){if(!e.length)return r;let t=e.shift();if(N(r)&&N(t))for(let o in t)N(t[o])?(r[o]||Object.assign(r,{[o]:{}}),y(r[o],t[o])):Object.assign(r,{[o]:t[o]});return y(r,...e)}function j(r){globalThis.__PERSPECTIVE_CONFIG__&&console.warn("Config already initialized!"),globalThis.__PERSPECTIVE_CONFIG__=y(O,r)}function b(){return globalThis.__PERSPECTIVE_CONFIG__||(globalThis.__PERSPECTIVE_CONFIG__=y(O,globalThis.__TEMPLATE_CONFIG__||{})),globalThis.__PERSPECTIVE_CONFIG__}var S=new WeakMap,A=0;function c(r,e){return function(){let t,o=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let l=s.length-1;l>=0;l--)typeof s[l]=="function"&&(t=s.splice(l,1)[0]);let p=S.get(t);S.delete(t);let u={cmd:e||"view_method",name:this._name,method:r,args:s,subscribe:!0,callback_id:p};this._worker.post(u,t,o),this._worker.unsubscribe(e,t)}}function f(r,e){return function(){let t,o=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let u=s.length-1;u>=0;u--)typeof s[u]=="function"&&(t=s.splice(u,1)[0]);A++,S.set(t,A);let p={cmd:e||"view_method",name:this._name,method:r,args:s,subscribe:!0,callback_id:A};this._worker.post(p,t,o,!0)}}function i(r,e){return function(){var t=Array.prototype.slice.call(arguments,0,arguments.length);return new Promise(function(o,s){var p={cmd:e||"view_method",name:this._name,method:r,args:t,subscribe:!1};this._worker.post(p,o,s)}.bind(this))}}function a(r,e,t){return new Promise((o,s)=>{this._worker=r,this._name=Math.random()+"",this._worker.post({cmd:"view",view_name:this._name,table_name:e,config:t},()=>{o(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&o(this)})}function Z(r,e){this._worker=r,this._name=e}Z.prototype=a.prototype;a.prototype.get_config=i("get_config");a.prototype.get_min_max=i("get_min_max");a.prototype.to_json=i("to_json");a.prototype.to_arrow=i("to_arrow");a.prototype.to_columns=i("to_columns");a.prototype.to_csv=i("to_csv");a.prototype.schema=i("schema");a.prototype.expression_schema=i("expression_schema");a.prototype.column_paths=i("column_paths");a.prototype.num_columns=i("num_columns");a.prototype.num_rows=i("num_rows");a.prototype.dimensions=i("dimensions");a.prototype.set_depth=i("set_depth");a.prototype.get_row_expanded=i("get_row_expanded");a.prototype.expand=i("expand");a.prototype.collapse=i("collapse");a.prototype.delete=i("delete");a.prototype.col_to_js_typed_array=i("col_to_js_typed_array");a.prototype.on_update=f("on_update","view_method",!0);a.prototype.remove_update=c("remove_update","view_method",!0);a.prototype.on_delete=f("on_delete","view_method",!0);a.prototype.remove_delete=c("remove_delete","view_method",!0);function w(r){let e=r;do for(let t of Object.getOwnPropertyNames(e)){let o=r[t];t!=="constructor"&&typeof o=="function"&&(r[t]=o.bind(r))}while(e=e!==Object&&Object.getPrototypeOf(e))}String.prototype.includes||(String.prototype.includes=function(r,e){return typeof e!="number"&&(e=0),e+r.length>this.length?!1:this.indexOf(r,e)!==-1});Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(r,e){if(this==null)throw new TypeError('"this" is null or not defined');var t=Object(this),o=t.length>>>0;if(o===0)return!1;var s=e|0,p=Math.max(s>=0?s:o-Math.abs(s),0);function u(l,h){return l===h||typeof l=="number"&&typeof h=="number"&&isNaN(l)&&isNaN(h)}for(;p<o;){if(u(t[p],r))return!0;p++}return!1}});function _(r,e,t){return new Promise((o,s)=>{this._worker=r,this._name=t.name||Math.random()+"",w(this),e.to_arrow?(this._worker.post({cmd:"table",name:this._name,args:[],options:t||{}}),e.to_arrow().then(p=>{this._worker.post({cmd:"table",name:this._name,args:[p],options:t||{}},()=>{e.on_update(u=>{this.update(u.delta)},{mode:"row"}),o(this)},s)})):this._worker.post({cmd:"table",name:this._name,args:[e],options:t||{}},()=>{o(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&o(this)})}_.prototype.type="table";function I(r,e){this._worker=r,this._name=e}I.prototype=_.prototype;_.prototype.view=function(r){return new a(this._worker,this._name,r)};_.prototype.query_columns=i("query_columns","table_method");_.prototype.get_index=i("get_index","table_method");_.prototype.get_limit=i("get_limit","table_method");_.prototype.make_port=i("make_port","table_method");_.prototype.remove_port=i("remove_port","table_method");_.prototype.schema=i("schema","table_method");_.prototype.validate_expressions=i("validate_expressions","table_method");_.prototype.is_valid_filter=i("is_valid_filter","table_method");_.prototype.size=i("size","table_method");_.prototype.num_rows=i("num_rows","table_method");_.prototype.num_columns=i("num_columns","table_method");_.prototype.columns=i("columns","table_method");_.prototype.clear=i("clear","table_method");_.prototype.replace=i("replace","table_method");_.prototype.delete=i("delete","table_method");_.prototype.on_delete=f("on_delete","table_method",!0);_.prototype.remove=i("remove","table_method");_.prototype.remove_delete=c("remove_delete","table_method",!0);_.prototype.update=function(r,e){return new Promise((t,o)=>{this._worker.post({name:this._name,cmd:"table_method",method:"update",args:[r,e||{}]},t,o,!1)})};_.prototype.execute=function(r){this._worker.post({cmd:"table_execute",name:this._name,f:r.toString()})};var d=class{constructor(){this._initialized=!1,this._worker={initialized:{value:!1},transferable:!1,msg_id:0,handlers:{},messages:[]},w(this)}unsubscribe(e,t){for(let o of Object.keys(this._worker.handlers))this._worker.handlers[o].resolve===t&&delete this._worker.handlers[o]}post(e,t,o,s=!1){++this._worker.msg_id,(t||o)&&(this._worker.handlers[this._worker.msg_id]={resolve:t,reject:o,keep_alive:s}),e.id=this._worker.msg_id,this._worker.initialized.value?this.send(e):this._worker.messages.push(()=>{this.send(e),(e.cmd==="table"||e.cmd==="view")&&!this._features?.wait_for_response&&t&&t()})}async memory_usage(){return await new Promise((e,t)=>{this.post({cmd:"memory_usage"},e,t)})}initialize_profile_thread(){this._worker.initialized.value?this.send({id:-1,cmd:"init_profile_thread"}):this._worker.messages.push(()=>this.send({id:-1,cmd:"init_profile_thread"}))}send(){throw new Error("send() not implemented")}async open_table(e){return new I(this,e)}_handle(e){if(!this._worker.initialized.value){this._initialized||(this._initialized=!0);let t=this._worker.messages;if(this._worker.initialized.value=!0,this._worker.messages=[],e.data?.data){this._features={};for(let o of e.data.data)this._features[o]=!0}if(t)for(let o in t)t.hasOwnProperty(o)&&t[o]()}if(e.data.id){let t=this._worker.handlers[e.data.id];t&&(e.data.error?t.reject(e.data.error):t.resolve(e.data.data),t.keep_alive||delete this._worker.handlers[e.data.id])}}table(e,t){return new _(this,e,t||{})}terminate(){this._worker.terminate(),this._worker=void 0}};import Q from"ws";var ee=3e4,k=class extends d{_ping(){this._ping_loop&&this._ws.send("ping"),this._ping_loop=setTimeout(this._ping.bind(this),ee)}_close(){clearTimeout(this._ping_loop),this._ping_loop=void 0,this._on_close_callback?.()}_onmessage(e){if(e.data!=="pong")if(this._pending_binary){let t=e.data;if(this._full_binary.set(new Uint8Array(t),this._total_chunk_length),this._total_chunk_length+=t.byteLength,this._total_chunk_length===this._pending_binary_length)t=this._full_binary.buffer;else return;let o={data:{id:this._pending_binary,data:t}};if(this._pending_port_id!==void 0){let s={port_id:this._pending_port_id,delta:t};o.data.data=s}this._handle(o),delete this._pending_binary,delete this._pending_binary_length,delete this._pending_port_id,this._total_chunk_length=0,this._full_binary=null}else e=JSON.parse(e.data),e.binary_length?(this._pending_binary=e.id,this._pending_binary_length=e.binary_length,e.data&&e.data.port_id!==void 0&&(this._pending_port_id=e.data.port_id),this._full_binary=new Uint8Array(this._pending_binary_length)):this._handle({data:e})}constructor(e){super(),this._ws=e,this._ws.binaryType="arraybuffer",this._full_binary,this._total_chunk_length=0,this._pending_binary_length=0,this._ws.onopen=()=>{this.send({id:-1,cmd:"init"})},this._ping(),this._ws.onclose=this._close.bind(this),this._ws.onmessage=this._onmessage.bind(this)}send(e){if(this._ws.readyState===Q.CLOSED){console.warn("Websocket connection is already closed.");return}if(e.args&&e.args.length>0&&e.args[0]instanceof ArrayBuffer&&e.args[0].byteLength!==void 0){let t=e;e.binary_length=e.args[0].byteLength,this._ws.send(JSON.stringify(t)),this._ws.send(e.args[0]);return}this._ws.send(JSON.stringify(e))}terminate(){return new Promise(e=>{this._on_close_callback=e,this._ws.close()})}};import{Decompress as te}from"fflate";import re from"../../src/js/perspective.worker.js";import oe from"../../dist/pkg/web/perspective.cpp.wasm";var F=!1;function q(r){return new Uint32Array(r.slice(0,4))[0]==559903}var R=function(){let r;return function(){return r||(r=new class{async worker(){return await re()}async wasm(){let e=await oe,t=[],o=0,s=new te(l=>{l&&(o+=l.byteLength,t.push(l))});if(e instanceof ArrayBuffer&&!e.buffer&&(e=new Uint8Array(e)),e.buffer&&e.buffer instanceof ArrayBuffer)F=!0,q(e.buffer)?s.push(e,!0):(o=e.byteLength,t=[e]);else if(e instanceof ArrayBuffer)o=e.byteLength,t=[new Uint8Array(e)];else{let h=(await fetch(e)).body.getReader(),m=0;for(;;){let{value:g,done:P}=await h.read();if(P)break;m===0&&q(g.buffer)||m===1?(m=1,s.push(g,P)):(m=2,o+=g.byteLength,t.push(g))}}let p=0,u=new Uint8Array(o);for(let l of t)u.set(l,p),p+=l.byteLength;return this._wasm=u.buffer,this._wasm}}),r}}(),E=class extends d{constructor(e){e&&j(e),super(),this.register()}async register(){let e,t={cmd:"init",config:b()};if(typeof WebAssembly>"u")throw new Error("WebAssembly not supported.");[e,t.buffer]=await Promise.all([R().worker(),R().wasm()]);for(var o in this._worker)e[o]=this._worker[o];this._worker=e,this._worker.addEventListener("message",this._handle.bind(this)),this._worker.postMessage(t),this._detect_transferable()}send(e){this._worker.transferable&&e.args&&e.args[0]instanceof ArrayBuffer?this._worker.postMessage(e,[e.args[0]]):this._worker.postMessage(e)}terminate(){this._worker.terminate(),this._worker=void 0}get transferable(){return this._worker?.transferable||!1}get inline(){return F}_detect_transferable(){var e=new ArrayBuffer(1);this._worker.postMessage(e,[e]),this._worker.transferable=e.byteLength===0}},ie=function(){let r,e;return{getInstance:function(t){r===void 0&&(r=new E(t));let o=JSON.stringify(t);if(e&&o!==e)throw new Error("Configuration object for shared_worker() has changed - this is probably a bug in your application.");return e=o,r}}}(),Ce=T;function ne(r){return R().set(r)}function se(r){return new E(r)}function ae(r=window.location.origin.replace("http","ws")){return new k(new WebSocket(r))}function _e(r){return ie.getInstance(r)}var Ge={override:ne,worker:se,websocket:ae,shared_worker:_e,...Object.keys(v)};export{Ge as default,Ce as get_type_config,ne as override,_e as shared_worker,ae as websocket,se as worker};
//# sourceMappingURL=perspective.js.map
